#!/bin/sh

set -e

if [ -z "$PORT" ]
then
  PORT=6881
fi

start() {
  echo "btpd is starting at $(date)"
  btpd \
    --port "$PORT" \
    &
}

notify_create() {
  dir=$1
  fifo=$2
  inotifywait \
    --monitor \
    --daemon \
    --outfile "$fifo" \
    --event create \
    "$dir"
}


watch() {
  echo watching for files in /var/btpd/in

  while read -r dir _ file
  do
    add_torrent "$dir/$file"
  done < /tmp/notify-in
}

add_torrent() {
  path=$1
  hash=$(echo "$path" | sha1sum | cut -f 1 -d ' ')
  name=$(basename "$path" | tr -d '[:space:]')
  cmd="btcli add -d /var/btpd/out/$hash -n $name $path"
  echo "$cmd"
  $cmd
}


mkfifo /tmp/notify-in
notify_create /var/btpd/in /tmp/notify-in
start
watch
